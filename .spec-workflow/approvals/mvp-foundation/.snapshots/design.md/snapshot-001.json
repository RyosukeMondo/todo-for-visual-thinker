{
  "id": "snapshot_1765698583994_85eeci3fq",
  "approvalId": "approval_1765698583989_zecy4uspx",
  "approvalTitle": "Design document for mvp-foundation",
  "version": 1,
  "timestamp": "2025-12-14T07:49:43.994Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\nThe MVP foundation delivers the baseline task lifecycle, CLI automation pathways, and visual canvas experience that every later feature relies on. The design keeps business logic in the `src/core` domain/use-case layer, exposes it through CLI commands (automation-first), and renders the state through the existing React infinite canvas (`TaskBoard`, `TaskCard`, minimap, filters). SQLite—via `better-sqlite3` adapters—persists all spatial/task metadata so that both CLI and UI can restore identical board state across sessions. Relationships, categories, and task filters share the same core data contracts to avoid divergent representations.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Hexagonal architecture**: Continue routing CLI + React UIs through `@core/usecases` and `@core/ports`, with adapters (`SQLite*Repository`, `ConsoleJsonLogger`) injected via `src/cli/runtime.ts` and React hooks in `src/web/hooks`.\n- **Type-safe + DI-first**: All services remain typed (TypeScript strict mode) and accept repositories/logger interfaces in their constructors. We reuse the `TodoRepository`, `RelationshipRepository`, and `CategoryRepository` contracts already defined in `src/core/ports`.\n- **Performance budgets**: CLI commands must complete in <50ms, React canvas renders stay under 500ms for 100 tasks, and SQLite queries stay within the `ListTodos` pagination defaults (limit 500) described in tech.md.\n- **Quality gates**: Maintain existing Vitest suites under `tests/` plus the `src/web` Testing Library specs to keep ≥80% coverage of domain logic and ≥90% on `create/update` flows per steering expectations.\n\n### Project Structure (structure.md)\n- Follow the structure documented in `tech.md` (Project Structure section) because a dedicated `structure.md` was not provided. Artifacts continue to live in `src/core` (domain/usecases/adapters), `src/cli` (Commander commands + runtime), `src/web` (React canvas + hooks/stores), `tests/` (unit/integration), and `.spec-workflow/specs/mvp-foundation` for specs.\n- New files will slot into existing directories: CLI interaction stays in `src/cli/commands`, canvas behavior in `src/web/components`/`hooks`, persistence in `src/core/adapters`, and shared DTOs/types in `src/shared`.\n\n## Code Reuse Analysis\nWe already have strong primitives to satisfy requirements. The design leans on them instead of rewriting functionality.\n\n- **Domain**: `Todo`, `Relationship`, and `Category` entities already enforce validation rules (length, hex colors, dependency types). They remain the single source of truth.\n- **Repositories**: `SQLiteTodoRepository`, `SQLiteRelationshipRepository`, and `SQLiteCategoryRepository` offer schema creation, filtering, and bulk delete; we reuse them for persistence.\n- **Use cases**: `CreateTodo`, `UpdateTodo`, `ListTodos`, relationship/category use cases, and `GetBoardSnapshot` expose the necessary orchestration for CLI and UI.\n- **CLI**: Commands under `src/cli/commands` (e.g., `addTodo.ts`, `listTodos.ts`, `updateTodo.ts`) already parse args and output JSON; enhancements will extend these commands instead of creating new binaries.\n- **Web UI**: Canvas-related components (`TaskBoard.tsx`, `TaskBoardCanvas.tsx`, `TaskBoardMinimap.tsx`, `TaskCard.tsx`, `TaskFilters.tsx`) plus hooks (`useTodos`, `useBoardViewport`) provide zoom/pan/drag behavior and will be extended to meet animation + filtering requirements.\n\n### Existing Components to Leverage\n- **`Todo` entity (`src/core/domain/Todo.ts`)**: Already models coordinates, colors, icons, and timestamps—no new entity required.\n- **`GetBoardSnapshot` use case**: Provides aggregated data for UI metrics panels (`TaskMetricsPanel.tsx`), so the canvas can derive dependency health and filters.\n- **`TaskBoard` component suite**: Implements infinite canvas controls, minimap, and connection drawing via `TaskBoard.connections.ts`. We'll extend the animation + persistence hooks using these files.\n- **CLI serialization helpers (`src/cli/serializers.ts`)**: Keep JSON structure consistent for automation consumers when new fields (icon, category) surface.\n\n### Integration Points\n- **SQLite storage**: All task/relationship operations continue using the SQLite repositories; migrations stay co-located with adapters.\n- **Commander CLI runtime**: `src/cli/program.ts` remains the entry point and wires CLI commands to use cases.\n- **React canvas**: Hooks in `src/web/hooks` (e.g., `useBoardState`) subscribe to store changes and trigger persistence writes via use cases exposed through a shared API context.\n\n## Architecture\nBusiness logic sits in the core layer, fronted by CLI and React. Repositories adapt SQLite; no UI directly touches SQLite.\n\n```mermaid\ngraph TD\n    CLI[CLI Commands] --> UC[Use Cases]\n    Web[React Canvas + Hooks] --> UC\n    UC --> Ports[Ports (Todo/Relationship/Category Repos)]\n    Ports --> SQLite[(SQLite DB via better-sqlite3)]\n    UC --> Logger[ConsoleJsonLogger]\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: Keep CLI commands <200 lines focusing on parsing and delegating to use cases; React components remain presentational while hooks manage state.\n- **Component Isolation**: Canvas controls (`TaskBoardCanvas`, `TaskBoardMinimap`, `TaskBoardHeader`) remain isolated to avoid monolithic files.\n- **Service Layer Separation**: `@core/usecases` mediate all writes/reads; UI and CLI never call repositories directly.\n- **Utility Modularity**: Shared helpers like `TaskBoard.viewport.ts` and CLI serializers remain small, composable utilities.\n\n## Components and Interfaces\n\n### 1. Core Task Lifecycle Service\n- **Purpose:** Coordinate creation, updates (status, position, color, icon), and deletion for todos + relationships through use cases.\n- **Interfaces:** `CreateTodo.execute(input)`, `UpdateTodo.execute({ id, patch })`, `ListTodos.execute(query)`, `CreateRelationship.execute`, etc.\n- **Dependencies:** `TodoRepository`, `RelationshipRepository`, `Logger`.\n- **Reuses:** Domain entities for validation; existing SQLite repositories for persistence.\n\n### 2. CLI Interaction Layer\n- **Purpose:** Provide automation-friendly commands with JSON output fulfilling Requirement 2.\n- **Interfaces:** Commander commands (`addTodo`, `listTodos`, `updateTodo`, `addRelationship`, etc.) each exposing `--json` and `--pretty` flags, plus shared option builders in `todoQueryOptions.ts`.\n- **Dependencies:** Use case services injected via `src/cli/runtime.ts`, CLI serialization utilities, Node stdout/stderr.\n- **Reuses:** Shared serializer + validation pipelines, `ConsoleJsonLogger` for structured logs.\n\n### 3. Canvas Interaction Engine\n- **Purpose:** Render the infinite canvas, handle drag/zoom/pan, show relationships, respect filters, and trigger persistence.\n- **Interfaces:**\n  - Hooks: `useBoardViewport()` (pan/zoom state), `useTodos()` (subscribe to store), `useRelationships()`.\n  - Components: `TaskBoardCanvas` (SVG/canvas layer), `TaskBoard.connections.ts` (Bezier path generation), `TaskCard` (visual states), `TaskBoardMinimap`.\n- **Dependencies:** Zustand (or current store), React DnD/pointer handlers, animation utilities, `ListTodos`/`ListRelationships` for data.\n- **Reuses:** Current `TaskBoard` component tree, `TaskBoard.constants.ts` for zoom thresholds, `TaskBoard.viewport.ts` for viewport math.\n\n### 4. Relationship & Filter Orchestrator\n- **Purpose:** Manage dependency graph (detect cycles, block invalid connects) and filtering for categories/status.\n- **Interfaces:**\n  - Use cases: `CreateRelationship`, `UpdateRelationship`, `DeleteRelationship`.\n  - UI: `TaskFilters` component, `DependencyHealthPanel`, `TaskHierarchyPanel`.\n- **Dependencies:** Relationship repository, `GetBoardSnapshot` for aggregated visibility, `TaskBoard.connections.ts` for rendering.\n- **Reuses:** Relationship domain entity validations, existing dependency metrics panels.\n\n## Data Models\n\n### TodoRecord\n```\ntype TodoRecord = {\n  id: string\n  title: string\n  description?: string\n  status: 'pending' | 'in_progress' | 'completed'\n  priority: 1 | 2 | 3 | 4 | 5\n  category?: string\n  color: `#${string}`\n  icon?: string\n  position: { x: number; y: number }\n  createdAt: number\n  updatedAt: number\n  completedAt?: number\n}\n```\n\n### RelationshipRecord\n```\ntype RelationshipRecord = {\n  id: string\n  fromId: string\n  toId: string\n  type: 'depends_on' | 'blocks' | 'related_to' | 'parent_of'\n  description?: string\n  createdAt: number\n  updatedAt: number\n}\n```\n\n### CategoryRecord\n```\ntype CategoryRecord = {\n  id: string\n  name: string\n  color: `#${string}`\n  icon?: string\n  createdAt: number\n}\n```\n\n### ViewportState\n```\ntype ViewportState = {\n  zoom: number // 0.25 - 4 range\n  offset: { x: number; y: number }\n  snapToGrid: boolean\n  filters: {\n    status?: TodoStatus[]\n    categories?: string[]\n    search?: string\n  }\n}\n```\n\n### CliResponse<T>\n```\ntype CliResponse<T> = {\n  status: 'success' | 'error'\n  data?: T\n  error?: { code: string; message: string; context?: Record<string, unknown> }\n}\n```\n\n## Error Handling\n\n### Scenario 1: Validation or constraint violations\n- **Handling:** Domain entities throw `ValidationError`; CLI catches and serializes with code/context; React surfaces inline toasts.\n- **User Impact:** CLI exits 1 with machine-readable JSON; UI highlights invalid fields and keeps optimistic state rolled back.\n\n### Scenario 2: Relationship cycle attempts\n- **Handling:** Use case performs DFS against existing `ListRelationships` output before saving. On detection, throw `DomainError` with `CYCLE_DETECTED` code.\n- **User Impact:** CLI surfaces descriptive error; UI shows toast plus highlights involved tasks without mutating canvas.\n\n### Scenario 3: Persistence or SQLite failures\n- **Handling:** Repository operations wrapped in try/catch to emit `RepositoryError` plus context; CLI logs actionable hints; UI toggles offline/degraded banner and retries via exponential backoff.\n- **User Impact:** Users see fail-fast messaging (e.g., “Unable to save task, please retry”) while state remains consistent (no optimistic commit).\n\n## Testing Strategy\n\n### Unit Testing\n- Domain entities (`Todo`, `Relationship`, `Category`) already have coverage; extend tests for new behaviors (icon validation, coordinate constraints, cycle detection) inside `tests/unit/core`.\n- CLI command option parsing and serializers validated with Vitest + mocks for repositories to guarantee JSON schema compatibility.\n\n### Integration Testing\n- Use `tests/integration` with an in-memory SQLite database (via temporary file) to validate CLI → use case → repository flows for CRUD and relationship creation.\n- React hooks/components tested via Testing Library to ensure drag/zoom updates coordinates, filters hide/show nodes, and animation toggles respect reduced-motion settings.\n\n### End-to-End Testing\n- Playwright-style flows cover: create/update/complete tasks via UI, persistence across reloads, dependency creation and cycle rejection, category filter toggling, CLI commands invoked via spawned process (snapshot tests on JSON output).\n- Include accessibility checks (axe) on the canvas and keyboard navigation across task cards.\n",
  "fileStats": {
    "size": 11208,
    "lines": 180,
    "lastModified": "2025-12-14T07:49:38.192Z"
  },
  "comments": []
}